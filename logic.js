var request = require('request');var jsdom = require('jsdom');var config_service_url = 'http://www.convertfiles.com/converter.php';var config_service_host = "www.convertfiles.com";var config_headers = {    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",    "Accept-Encoding": "gzip,deflate,sdch",    "Accept-Language": "de-DE,de;q=0.8,en-US;q=0.6,en;q=0.4,nl;q=0.2",    "Cache-Control": "max-age=0",    "Connection": "keep-alive",    "DNT": " 1",    "Host ": config_service_host,    "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/34.0.1847.131 Safari/537.36"};var func_sendconvert = function (jobid, fileurl, callback) {        var form = {        download_url: fileurl,        file_or_url: 'url',        youtube_mode: 'default',        input_format: '.mp3',        output_format: '.wav',        APC_UPLOAD_PROGRESS: jobid    };    request.post({ url: config_service_url, form: form, headers: config_headers }, function (e, r, body) {                        if (!e && r.statusCode == 200)            func_polljob(jobid,callback);        else            console.log("[logic.js] ##### service nicht gefunden");    });};var func_getdownloadurl = function (jobid,callback) {    var url = "http://www.convertfiles.com/convertrogressbar.php?progress_key=" + jobid + "&i=1";        var done = false;        setTimeout(function() {        if(!done){            clearInterval(interval);            console.log("[logic.js] timeout");            callback({ok:false});        }        }, 15000);        var interval = setInterval(function () {                request.post({ url: url}, function (e, r, html) {        if (!e && r.statusCode == 200) {            jsdom.env({                html:html,                scripts: [ 'http://code.jquery.com/jquery-1.9.1.min.js' ],                done: function (errs, window) {                                        var _downloadurl = window.$('a:eq(0)').attr("href");                    var _deletedownloadurl = window.$('a:eq(1)').attr("href")                                        console.log("[logic.js] call");                                        if(_downloadurl && _deletedownloadurl){                        clearInterval(interval);                        done = true;                                                console.log("[logic.js] dl "+jobid+" ready @: "+_downloadurl);                                                callback({ok:true, dl:_downloadurl, del:_deletedownloadurl, id:jobid});                                               }                    else {                        //callback({ok:false});                    }                }            });        } else {            console.log("[logic.js] final nicht gefunden");            clearInterval(interval);        }    });            },1000);        }var func_polljob = function (jobid,callback) {    console.log("[logic.js] jobstarted: "+jobid);        setTimeout(function() {        if(!done){            clearInterval(interval);            console.log("[logic.js] timeout");            callback({ok:false});        }        }, 15000);        var interval = setInterval(function () {        request.get({ url: "http://www.convertfiles.com/getprogress.php?progress_key=" + jobid, headers: config_headers }, function (e, r, body) {            if (!e && r.statusCode == 200) {                console.log("[logic.js] jobprogress: " + body);                                if (body == "100") {                    done = true;                    clearInterval(interval);                    console.log("[logic.js] yeah - job done");                    func_getdownloadurl(jobid,callback);                }            } else {                console.log("[logic.js] progress nicht gefunden");                clearInterval(interval);            }        });    }, 300)}// create jobid//var jobid = func_getID(14);exports.run = function (job, callback){    func_sendconvert(job.jobid, job.dropboxurl, callback);}exports.func_getID = function (idLength) {    var chars = "0,1,2,3,4,5,6,7,8,9,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z";    chars = chars.split(",");    var min = 0;    var max = chars.length - 1;    var unique_id = "";    for (var i = 0; i < idLength; i++) {        unique_id += chars[Math.floor(Math.random() * (max - min + 1) + min)];    }    return unique_id;}